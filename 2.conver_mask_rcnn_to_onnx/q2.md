# description

Please clone [**Global Tracking Transformers**](https://github.com/xingyizhou/GTR#readme)
```bash
git clone https://github.com/xingyizhou/GTR.git --recurse-submodules
```

GTR is mask-rcnn based model for tracking, and its tracking transformer is a head of it just like box and mask heads. 


Due to Mask-rcnn has a NMS between the proposal network and its heads, and it is challenge to conevrt it to onnx. 


If possible we'd like to convert data flow within the 
```bash
    def inference(
        self,
        batched_inputs: Tuple[Dict[str, torch.Tensor]],
        detected_instances: Optional[List[Instances]] = None,
        do_postprocess: bool = True,
    ):
```
of GTR/gtr/modeling/meta_arch/custom_rcnn.py to onnx

# Detail
The problem will be soloved if you we run TensorRT/samples/python/detectron2/create_onnx.py. 
You can refer TensorRT/samples/python/detectron2/README.md for more details.
Here is some scripts to reproduce the error in a fastï¼š

1.

```bash
conda create -n mask_rcnn_conversion python=3.8 -y
conda activate mask_rcnn_conversion
mkdir mask_rcnn_conversion
cd mask_rcnn_conversion

pip install torch==1.12.1+cu113 torchvision==0.13.1+cu113 torchaudio==0.12.1 --extra-index-url https://download.pytorch.org/whl/cu113
pip install opencv-python
pip install protobuf==3.20.0
pip install onnx==1.12.0
pip install onnxruntime==1.12.1
git clone https://github.com/facebookresearch/detectron2.git
python -m pip install -e detectron2
git clone https://github.com/NVIDIA/TensorRT.git
python3 -m pip install TensorRT/tools/onnx-graphsurgeon --index-url https://pypi.ngc.nvidia.com
wget https://dl.fbaipublicfiles.com/detectron2/COCO-Detection/faster_rcnn_R_50_FPN_3x/137849458/model_final_280758.pkl
```
2.

Please download 1344x1344.jpg in this directory.

3.
```bash
Change lines 160-162 of detectron2/tools/deploy/export_model.py 
aug = T.ResizeShortestEdge(
    [cfg.INPUT.MIN_SIZE_TEST, cfg.INPUT.MIN_SIZE_TEST], cfg.INPUT.MAX_SIZE_TEST
)
```
to
```bash
aug = T.ResizeShortestEdge(
    [1344, 1344], 1344
)
```
4.
```bash
python detectron2/tools/deploy/export_model.py \
    --sample-image 1344x1344.jpg \
    --config-file detectron2/configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml \
    --export-method tracing \
    --format onnx \
    --output ./ \
    MODEL.WEIGHTS model_final_280758.pkl \
    MODEL.DEVICE cuda

python TensorRT/samples/python/detectron2/create_onnx.py \
    --exported_onnx model.onnx \
    --onnx converted.onnx \
    --det2_config detectron2/configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml \
    --det2_weights model_final_280758.pkl \
    --sample_image 1344x1344.jpg
```
The model.onnx generated by detectron2/tools/deploy/export_model.py cannot run on new images, beacuese of diffenert tensor size after NMS. The TensorRT/samples/python/detectron2/create_onnx.py aims to change the structure of model.onnx to allow tensor shape changing within the onnx. 

I got following error:
```bash
Traceback (most recent call last):
  File "TensorRT/samples/python/detectron2/create_onnx.py", line 547, in <module>
    main(args)
  File "TensorRT/samples/python/detectron2/create_onnx.py", line 528, in main
    det2_gs.process_graph(anchors, args.first_nms_threshold, args.second_nms_threshold)
  File "TensorRT/samples/python/detectron2/create_onnx.py", line 514, in process_graph
    p2, p3, p4, p5 = backbone()
  File "TensorRT/samples/python/detectron2/create_onnx.py", line 365, in backbone
    return p2.outputs[0], p3.outputs[0], p4.outputs[0], p5.outputs[0]
AttributeError: 'NoneType' object has no attribute 'outputs'
...
I try to fix the TensorRT/samples/python/detectron2/create_onnx.py according the issues they disscussed on github. But I always get new error, when I fix one.
